<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrar asistencias</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="body-admin">
  <a href="{{ url_for('admin') }}" class="btn-volver-inicio">Volver al inicio</a>

  <h2>Administrar asistencias de las reservas</h2>

  <!-- Buscar reserva -->
  <form method="POST" class="form-horizontal">
    <label for="id_reserva">ID de la reserva:</label>
    <input type="number" id="id_reserva" name="id_reserva" placeholder="Ej: 10" required>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" name="accion" value="buscar" class="btn-agregar">Buscar</button>
  </form>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container margin-bottom">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if reserva %}
    <div class="reserva-detalle">
      <div class="resumen-reserva">
        <h3>Reserva #{{ reserva.id_reserva }}</h3>
        <p><strong>Sala:</strong> {{ reserva.nombre_sala }}</p>
        <p><strong>Edificio:</strong> {{ reserva.edificio }}</p>
        <p><strong>Fecha:</strong> {{ reserva.fecha.strftime('%d/%m/%Y') }}</p>
        <p><strong>Turno:</strong> {{ reserva.hora_inicio }} – {{ reserva.hora_fin }}</p>
        <p><strong>Capacidad:</strong> {{ participantes|length }}/{{ reserva.capacidad }}</p>
        <p><strong>Tipo de sala:</strong> {{ reserva.tipo_sala }}</p>
        <p><strong>Estado:</strong> {{ reserva.estado }}</p>
      </div>
    </div>

    <h2 class="sub">Listado de Participantes</h2>

    <!-- Listado de asistencias -->
    <form method="POST">
      <input type="hidden" name="accion" value="guardar">
      <input type="hidden" name="id_reserva" value="{{ reserva.id_reserva }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <table class="tabla-admin">
        <thead>
          <tr>
            <th>CI</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Asistencia</th>
          </tr>
        </thead>
        <tbody>
          {% for p in participantes %}
          <tr>
            <td>{{ p.ci_participante }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.apellido }}</td>
            <td>
              <select name="asistencia_{{ p.ci_participante }}"
                      class="select-asistencia"
                      {% if not editable %}disabled{% endif %}>
                  <option value="1" {% if p.asistencia == 1 %}selected{% endif %}>Asiste</option>
                  <option value="0" {% if p.asistencia == 0 %}selected{% endif %}>Falta</option>
              </select>

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if editable %}
      <button type="submit" class="btn-agregar">Guardar cambios</button>
      {% else %}
      <p class="mensaje-info">
        Esta reserva ya no puede editarse porque finalizó hace más de 10 minutos.
      </p>
      {% endif %}

    </form>
  {% elif id_reserva %}
    <p>No se encontraron participantes para el ID ingresado.</p>
  {% endif %}
</body>
</html>
